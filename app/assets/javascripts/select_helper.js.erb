/* global $ */

function clearFields (selectDiv) {
  // Make the options list empty
  var selectList = selectDiv.find('select')[0]
  if (typeof selectList !== 'undefined') {
    selectList.options.length = 0
    // Remove the previously-selected option name
    var prevOption = selectDiv.find('.ui-selectmenu-text')[0]
    if (prevOption != null) {
      prevOption.innerHTML = '&nbsp'
      disableSelect($(selectDiv).find('select'))
    }
  }

  return selectList
}

function disableSelect (selectElement) {
  $(selectElement).attr('disabled', 'disabled').addClass('disabled')
  $(selectElement).selectmenu('disable')
}

function enableSelect (selectElement) {
  $(selectElement).removeAttr('disabled').removeClass('disabled')
  $(selectElement).selectmenu('enable')
  $(selectElement).selectmenu('refresh')
}

function setFields (selectList, url, data, prompt, callback) {
  if (prompt == null){ prompt = true}
  $.getJSON({
    url: url,
    data: data
  }).done(function (results) {
    if (prompt){
      var promptOption = document.createElement('option')
      promptOption.value = ''
      promptOption.name = ''
      promptOption.textContent = '<%= I18n.t(".rooms.choose") %>'
      selectList.appendChild(promptOption)
    }

    if (selectList.hasAttribute('data-all-option') &&
        selectList.attributes["data-all-option"].value === "true"){
      var allOption = document.createElement('option')
      allOption.value = '<%= I18n.t(".lists.all_value") %>'
      allOption.name = '<%= I18n.t(".lists.all_name") %>'
      allOption.textContent = '<%= I18n.t(".lists.all_prompt") %>'
      selectList.appendChild(allOption)
    }

    $.each(results, function (key, value) {
      var option = document.createElement('option')
      option.value = value.id
      option.name = value.name
      option.selected = value.selected
      option.textContent = value.name

      selectList.appendChild(option)
    })

    if (results.length > 0) {
      enableSelect('#' + selectList.id)
      clearMatchErrors()
    } else {
      disableSelect('#' + selectList.id)
      if (url === '/finish_list') {
        noMatches('<%= I18n.t(".finishes.no_match") %>')
      } else if (url === '/appliance_list') {
        noMatches('<%= I18n.t(".appliances.no_match") %>')
      }
    };

    if(callback != null){
      callback()
    }
  }).fail(function (response) {
    console.error('Call to ' + url + ' failed')
  })
}

function noMatches (errorMessage) {
  var $errors = $(document).find('.match-errors')
  $errors[0].innerHTML = errorMessage
}

function clearMatchErrors () {
  $('.match-errors').html('')
}

function selectMeta(class_name) {
  json = {};
  try {
    json.div = $(class_name)
    json.text = json.div.find('.ui-selectmenu-text')[0].innerHTML
    json.id = json.div.find('select option:contains('+json.text+')')[0].value
  }
  catch(err) {} // ignore unpopulated fields
  return json
}

