document.addEventListener("turbolinks:load", function () {
  $('.select-with-filter select').selectmenu({
    create: function (event, ui) {
      var $select = $(event.target);

      $select.find('option[value=""]').attr("value", "-1").text("<%= I18n.t("js.select_with_filter.choose") %>");
      $select.data('unfilteredOptions', $select.find('option').clone());
      $select.selectmenu('refresh');
    }
  });

  $( '.cascade-filter select' ).selectmenu({
    select: function (event, ui) {
      var $selectField = $(ui.item.element.context).parent();
      var filterOn = $selectField.parent().data('filter');
      var filterVal = ui.item.value;
      var ignoreSelect = filterVal === "-1";

      if (ignoreSelect) { return; }

      if (filterVal) {
        filterSelect(filterOn, filterVal);
      } else {
        resetSelectFilters();
      }
    }
  });

  function filterSelect(filterOn, filterVal) {
    $('.filterable')
      .not('[data-filter="'+ filterOn +'"]')
      .find('select')
      .each(function (index, selectInput) {
        var unfilteredOptions = $(selectInput).data('unfilteredOptions');
        var $selectInput = $(selectInput);

        if (unfilteredOptions) {
          var filteredOptions = unfilteredOptions
              .filter('option[data-'+ filterOn +'="'+ filterVal +'"]');

          $selectInput.find('option').remove();

          if (filteredOptions.length > 0) {
            var promptOption = newPromptOption("<%= I18n.t("js.select_with_filter.choose") %>");

            $selectInput.append(promptOption);
            unselectAllOptions(filteredOptions);
            $selectInput.append(filteredOptions);
            $selectInput.selectmenu('enable');
            $selectInput.selectmenu('refresh');
          } else {
            var dudOption = newPromptOption('n/a');

            $selectInput.append(dudOption);
            $selectInput.selectmenu('refresh');
            $selectInput.selectmenu('disable');
          };
        };
      });
  };

  function newPromptOption(text) {
    var option = document.createElement('option');

    option.value = "-1";
    option.name = '';
    option.textContent = text;
    return option;
  };

  function resetSelectFilters() {
    $('.filterable select').each(function(index, selectInput) {
      var $selectInput = $(selectInput);
      var unfilteredOptions = $selectInput.data('unfilteredOptions');

      $selectInput.find('option').remove();

      unselectAllOptions(unfilteredOptions);
      $selectInput.append(unfilteredOptions);

      $selectInput.selectmenu('enable');
      $selectInput.selectmenu('refresh');
    });
  };

  function unselectAllOptions($options) {
    $.each($options.filter(':selected'), function() {
      $(this).prop('selected', false);
    });
  };
});
