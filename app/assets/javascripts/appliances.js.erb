/* global $, clearFields, setFields */
$(document).on('click', '.appliance-add .ui-menu-item', function (event) {
  var $selectContainer = $(this).closest('.select-container')

  if ($selectContainer.length) {
    var listClasses = $selectContainer[0].classList
    var $parentFieldset = $selectContainer.closest('.appliance-add')

    if (listClasses.contains('appliance_manufacturer') ||
        listClasses.contains('appliance_category')) {

      var category = selectMeta('.appliance_category')
      var manufacturer = selectMeta('.appliance_manufacturer')
      var $applianceDiv = $parentFieldset.find('.appliances')
      var $applianceSelect = clearFields($applianceDiv)

      if(category.id != 0 && manufacturer.id != 0) {
        var url = '/appliance_list'
        setFields($applianceSelect, url, { manufacturer: manufacturer.id, category: category.id })
        updateDefaultName(manufacturer.name, null)
      }
    }
  }
})

$(document).on('change paste keyup', '.appliance_model_num', function (event) {
  var modelName = $(this).find('input')[0].value
  updateDefaultName(null, modelName)
})

$(document).on('click', '.manufacturer .ui-menu-item', function (event) {
  var manufacturerName = $(this).innerText
  updateDefaultName(manufacturerName, null)
})

function updateDefaultName (manufacturer, model) {
  var $applianceName = $('.appliance_full_name').find('input')

  if (manufacturer == null) {
    var $manufacturerDiv = $('.appliance_appliance_manufacturer')
    manufacturer = $manufacturerDiv.find('.ui-selectmenu-text')[0].innerHTML.replace(/&nbsp;/g, '').replace(/Choose.../g, '').trim()
  }

  if (model == null) {
    var $modelDiv = $('.appliance_model_num')
    model = $modelDiv.find('input')[0].value.trim()
  }

  $applianceName.val(manufacturer + ' ' + model)
}

document.addEventListener('turbolinks:load', function (event) {

  if ($("#appliance_appliance_category_id").length == 0) { return }

  show_ratings()

  $("#appliance_appliance_category_id").selectmenu({
    select: function (event, ui) {
      show_ratings()
    }
  })

  $("#appliance_main_uk_e_rating").selectmenu({
    select: function (event, ui) {
      check_ratings()
    }
  })

  $("#appliance_supp_uk_e_rating").selectmenu({
    select: function (event, ui) {
      check_ratings()
    }
  })
})

function check_ratings(){
  $(".e_rating").toggle($("#appliance_main_uk_e_rating").val() == 0 && $("#appliance_supp_uk_e_rating").val() == 0)
}

function show_ratings() {
  // Washer Dryer
  washerDryer = $("#appliance_appliance_category_id").val() == 2
  $("#main_rating").toggle(!washerDryer)
  $("#washerdryer_rating").toggle(washerDryer)
  $("#washer_rating").toggle(washerDryer)
  if (!washerDryer &&  $('#appliance_supp_uk_e_rating').val() != "not_known") {
    $('#appliance_supp_uk_e_rating').val("not_known")
    $('#appliance_supp_uk_e_rating').selectmenu('refresh')
  }
}
