/* global $, clearFields, setFields */
var $document = $(document)

$document.on('keypress', 'form', function (event) {
  var RETURN = 13

  if (event.keyCode === RETURN) {
    var $searchField = $('.search-field')
    var $searchApplianceField = $('.search-appliance-field')
    var $searchFinishField = $('.search-finish-field')
    var $searchUserField = $('.search-user-field')
    // If there is a search value, process the search
    if ($searchField.val()) {
      searchGlobal()
    } else if ($searchApplianceField.val()) {
      searchAppliance()
    } else if ($searchFinishField.val()) {
      searchFinish()
    } else if ($searchUserField.val()) {
      searchUser()
    }

    // Whether or not there is a search value, don't allow the user
    // to submit the form using "enter" key, unless this is a sign_in page
    var homeownerSignInPage = $('.login-view').length > 0
    var acceptPage = $('.accept-view').length > 0
    var signInPage = window.location.pathname.includes('sign_in')

    return !!(homeownerSignInPage || signInPage || acceptPage)
  }
})

$document.on('click', '.search-btn', function (event) {
  event.preventDefault()
  searchGlobal()
})

function searchGlobal () {
  var $searchField = $('.search-field')
  var searchText = $searchField[0].value

  var url = '/search'
  var $homeowner = $('.homeowner-view')
  if ($homeowner.length > 0) {
    url = '/homeowner_search'
  }

  var data = { search_term: searchText.trim() }
  var $searchList = $('.search-results')
  setSearchFields($searchList, url, data)
}

$document.on('click', '.search-appliance-btn', function (event) {
  event.preventDefault()
  var $categorySelect = $('.appliance_category').find('select')
  $categorySelect.val('')
  $categorySelect.selectmenu('refresh')
  clearFields($('.appliance_manufacturer'))
  searchAppliance()
})

function searchAppliance () {
  var $searchField = $('.search-appliance-field')
  var searchText = $searchField[0].value

  var url = '/appliance_search'
  var data = { search_term: searchText }

  var $applianceResultsDiv = $('.appliances')
  var $applianceSelect = clearFields($applianceResultsDiv)
  setFields($applianceSelect, url, data)
}

$document.on('click', '.search-finish-btn', function (event) {
  event.preventDefault()
  var $categorySelect = $('.finish_category').find('select')
  $categorySelect.val('')
  $categorySelect.selectmenu('refresh')
  clearFields($('.finish_type'))
  clearFields($('.finish_manufacturer'))
  searchFinish()
})

function searchFinish () {
  var $searchField = $('.search-finish-field')
  var searchText = $searchField[0].value

  var url = '/finish_search'
  var data = { search_term: searchText }

  var $applianceResultsDiv = $('.finishes')
  var $applianceSelect = clearFields($applianceResultsDiv)
  setFields($applianceSelect, url, data)
}

$document.on('click', '.search-user-btn', function (event) {
  searchUser()
})

function searchUser () {
  var $searchField = $('.search-user-field')
  var searchText = $searchField[0].value
  var data = { search_term: searchText.trim() }
  var $searchList = $('.user-search-results')
  setSearchFields($searchList, $searchField.data('path') , data)
}

function setSearchFields ($searchList, url, data) {
  $.getJSON({
    url: url,
    data: data
  }).done(function (results) {
    $searchList.empty()

    $.each(results, function (key, value) {
      var span1 = document.createElement('span')
      span1.className = 'strong'
      span1.innerHTML = value.type + ' '

      var span2 = document.createElement('span')
      span2.innerHTML = value.name

      var a = document.createElement('a')
      a.setAttribute('href', value.path)
      a.appendChild(span1)
      a.appendChild(span2)

      var li = document.createElement('li')
      li.appendChild(a)

      $searchList.append(li)
    })
  })
}
