/* global $, clearFields, setFields */
var $document = $(document)

$document.on('keypress', 'form', function (event) {
  var RETURN = 13

  if(event.target.tagName == 'TEXTAREA') {
    if(event.keyCode == RETURN) {
          return true;
    }
  }

  if (event.keyCode === RETURN) {
    var $searchField = $('.search-field')
    var $searchApplianceField = $('.search-appliance-field')
    var $searchFinishField = $('.search-finish-field')
    var $searchIndexFinishField = $('.search-index-finish-field')
    var $searchUserField = $('.search-user-field')
    // If there is a search value, process the search
    if ($searchField.val()) {
      searchGlobal()
    } else if ($searchApplianceField.val()) {
      searchAppliance()
    } else if ($searchFinishField.val()) {
      searchFinish()
    } else if ($searchIndexFinishField.val()) {
      searchIndexFinish()
    } else if ($searchUserField.val()) {
      searchUser()
    }

    // Whether or not there is a search value, don't allow the user
    // to submit the form using "enter" key, unless this is a sign_in page
    var homeownerSignInPage = $('.login-view').length > 0
    var acceptPage = $('.accept-view').length > 0
    var signInPage = window.location.pathname.includes('sign_in')

    return !!(homeownerSignInPage || signInPage || acceptPage)
  }
})

$document.on('click', '.search-btn', function (event) {
  event.preventDefault()
  searchGlobal()
})

function searchGlobal () {
  var $searchField = $('.search-field')
  var searchText = $searchField[0].value

  var url = '/search'
  var $homeowner = $('.homeowner-view')
  if ($homeowner.length > 0) {
    url = '/homeowner_search'
  }

  var data = { search_term: searchText.trim() }
  var $searchList = $('.search-results')
  setSearchResults($searchList, url, data, false)
}

$document.on('click', '.search-appliance-btn', function (event) {
  event.preventDefault()
  var $categorySelect = $('.appliance_category').find('select')
  $categorySelect.val('')
  $categorySelect.selectmenu('refresh')
  clearFields($('.appliance_manufacturer'))
  searchAppliance()
})

function searchAppliance () {
  var $searchField = $('.search-appliance-field')
  var searchText = $searchField[0].value

  var url = '/appliance_search'
  var data = { search_term: searchText }

  var $applianceResultsDiv = $('.appliances')
  var $applianceSelect = clearFields($applianceResultsDiv)
  setFields($applianceSelect, url, data)
}

$document.on('click', '.search-finish-btn', function (event) {
  event.preventDefault()
  var $categorySelect = $('.finish_category').find('select')
  $categorySelect.val('')
  $categorySelect.selectmenu('refresh')
  clearFields($('.finish_type'))
  clearFields($('.finish_manufacturer'))
  searchFinish()
})

function searchFinish () {
  var $searchField = $('.search-finish-field')
  var searchText = $searchField[0].value

  var url = '/finish_search'
  var data = { search_term: searchText }

  var $applianceResultsDiv = $('.finishes')
  var $applianceSelect = clearFields($applianceResultsDiv)
  setFields($applianceSelect, url, data)
}

$document.on('click', '.search-user-btn', function (event) {
  searchUser()
  return false
})

function searchUser () {
  setSearchFields($('.search-user-field'), $('.user-search-results'), false)
}

$document.on('click', '.search-index-finish-btn', function (event) {
  searchIndexFinish()
  return false
})

function searchIndexFinish() {
  setSearchFields($('.search-index-finish-field'), $('.search-finish-results'), true)
}

function setSearchFields(search_field, search_results, scroll_overflow) {
  var searchText = search_field[0].value
  var search_term = { search_term: searchText.trim() }
  setSearchResults(search_results, search_field.data('path') , search_term, scroll_overflow)
}

function setSearchResults (search_results, url, search_term, scroll_overflow) {
  if (search_term.search_term === "") { return }
  $.getJSON({
    url: url,
    data: search_term
  }).done(function (results) {
    search_results.empty()

    if (results.length > 6 && scroll_overflow) {
      search_results.addClass("overflow")
    } else {
      search_results.removeClass("overflow")
    }

    $.each(results, function (key, value) {
      if (value.type != undefined ) {
        var span1 = document.createElement('span')
        span1.className = 'strong'
        span1.innerHTML = value.type + ' '
      }

      var span2 = document.createElement('span')
      span2.innerHTML = value.name

      var a = document.createElement('a')
      a.setAttribute('href', value.path)
      if (span1 != undefined ) { a.appendChild(span1)}
      a.appendChild(span2)

      var li = document.createElement('li')
      li.appendChild(a)

      search_results.append(li)
    })
  })
}
