/* global $, clearFields, setFields */
var $document = $(document)

$document.on('keypress', 'form', function (event) {
  var RETURN = 13

  if(event.target.tagName == 'TEXTAREA') {
    if(event.keyCode == RETURN) {
          return true;
    }
  }

  searches = [
    [$('.search-field'), searchGlobal],
    [$('.search-appliance-field'), searchAppliance],
    [$('.search-index-appliance-field'), searchIndexAppliance],
    [$('.search-finish-field'), searchFinish],
    [$('.search-index-finish-field'), searchIndexFinish],
    [$('.search-user-field'), searchUser]
  ];

  if (event.keyCode === RETURN) {
    if (event.target.value != "") {
      for (i = 0; i < searches.length; ++i) {
        if (event.target == searches[i][0][0]) {
          clearSearchResults()
          if (event.target.value != "") {
            searches[i][1]()
          }
        }
      }
    }

    // Whether or not there is a search value, don't allow the user
    // to submit the form using "enter" key, unless this is a sign_in page
    var homeownerSignInPage = $('.login-view').length > 0
    var acceptPage = $('.accept-view').length > 0
    var signInPage = window.location.pathname.includes('sign_in')

    return !!(homeownerSignInPage || signInPage || acceptPage)
  }
})

$document.on('click', '.search-btn', function (event) {
  event.preventDefault()
  searchGlobal()
})

function searchGlobal () {
  var $searchField = $('.search-field')
  var searchText = $searchField[0].value

  var url = '/search'
  var $homeowner = $('.homeowner-view')
  if ($homeowner.length > 0) {
    url = '/homeowner_search'
  }

  var data = { search_term: searchText.trim() }
  var $searchList = $('.search-results')
  setSearchResults($searchField, url, data, false)
}

$document.on('click', '.search-appliance-btn', function (event) {
  event.preventDefault()
  searchAppliance()
})

function searchAppliance () {
  var $categorySelect = $('.appliance_category').find('select')
  $categorySelect.val('')
  $categorySelect.selectmenu('refresh')
  var $manufacturerSelect = $('.appliance_manufacturer').find('select')
  $manufacturerSelect.val('')
  $manufacturerSelect.selectmenu('refresh')

  var $searchField = $('.search-appliance-field')
  var searchText = $searchField[0].value

  var url = '/appliance_search'
  var data = { search_term: searchText }

  var $applianceResultsDiv = $('.appliances')
  var $applianceSelect = clearFields($applianceResultsDiv)
  setFields($applianceSelect, url, data)
}

$document.on('click', '.search-finish-btn', function (event) {
  event.preventDefault()
  searchFinish()
})

function searchFinish () {
  var $categorySelect = $('.finish_category').find('select')
  $categorySelect.val('')
  $categorySelect.selectmenu('refresh')
  clearFields($('.finish_type'))
  clearFields($('.finish_manufacturer'))

  var $searchField = $('.search-finish-field')
  var searchText = $searchField[0].value

  var url = '/finish_search'
  var data = { search_term: searchText }

  var $applianceResultsDiv = $('.finishes')
  var $applianceSelect = clearFields($applianceResultsDiv)
  setFields($applianceSelect, url, data)
}

$document.on('click', '.search-user-btn', function (event) {
  event.preventDefault()
  searchUser()
})

function searchUser () {
  setSearchFields($('.search-user-field'), false)
}

$document.on('click', '.search-index-finish-btn', function (event) {
  event.preventDefault()
  searchIndexFinish()
})

function searchIndexFinish() {
  setSearchFields($('.search-index-finish-field'), true)
}

function searchIndexAppliance() {
  setSearchFields($('.search-index-appliance-field'), true)
}

function setSearchFields(search_field, scroll_overflow) {
  var searchText = search_field[0].value
  var search_term = { search_term: searchText.trim() }
  setSearchResults(search_field, search_field.data('path') , search_term, scroll_overflow)
}

function setSearchResults (search_field, url, search_term, scroll_overflow) {
  clearSearchResults()
  search_results = search_field.closest(".search-container").find(".search-results")
  if (search_term.search_term === "") { return }
  $.getJSON({
    url: url,
    data: search_term
  }).done(function (results) {
    if (results.length > 6 && scroll_overflow) {
      search_results.addClass("overflow")
    } else {
      search_results.removeClass("overflow")
    }

    $.each(results, function (key, value) {
      if (value.type != undefined ) {
        var span1 = document.createElement('span')
        span1.className = 'strong'
        span1.innerHTML = value.type + ' '
      }

      var span2 = document.createElement('span')
      span2.innerHTML = value.name

      var a = document.createElement('a')
      a.setAttribute('href', value.path)
      if (span1 != undefined ) { a.appendChild(span1)}
      a.appendChild(span2)

      var li = document.createElement('li')
      li.appendChild(a)

      search_results.append(li)
    })
  })
}

function clearSearchResults() {
  $( ".search-results" ).each(function( index ) { $(this).empty() })
}
